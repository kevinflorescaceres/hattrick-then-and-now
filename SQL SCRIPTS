------------------------QUERYS TORNEO ESPECIFICO

SELECT 
    p.ID_MATCH,
    e1.Nombre AS Local,
    e2.Nombre AS Visitante,
    p.Goles_Local,
    p.Goles_Visita,
    p.Fecha,
    p.Torneo
FROM Partidos p
JOIN Equipos e1 ON p.Local_ID = e1.ID_TEAM
JOIN Equipos e2 ON p.Visita_ID = e2.ID_TEAM
WHERE p.Torneo = 'QPMD';

------------------HEAD2HEAD

WITH params AS (
    SELECT 
        2 AS equipo1_id,  -- Los Danmucobois
        5 AS equipo2_id   -- Obsidiana
)
SELECT
    COUNT(*) AS Partidos_Jugados,
    SUM(
        CASE 
            WHEN (p.Local_ID = params.equipo1_id AND p.Goles_Local > p.Goles_Visita) 
              OR (p.Visita_ID = params.equipo1_id AND p.Goles_Visita > p.Goles_Local) 
            THEN 1 ELSE 0 
        END
    ) AS Ganados_Equipo1,
    SUM(
        CASE 
            WHEN p.Goles_Local = p.Goles_Visita THEN 1 ELSE 0 
        END
    ) AS Empates,
    SUM(
        CASE 
            WHEN (p.Local_ID = params.equipo1_id AND p.Goles_Local < p.Goles_Visita) 
              OR (p.Visita_ID = params.equipo1_id AND p.Goles_Visita < p.Goles_Local) 
            THEN 1 ELSE 0 
        END
    ) AS Ganados_Equipo2,
    SUM(
        CASE 
            WHEN p.Local_ID = params.equipo1_id THEN p.Goles_Local
            WHEN p.Visita_ID = params.equipo1_id THEN p.Goles_Visita 
        END
    ) AS GF_Equipo1,
    SUM(
        CASE 
            WHEN p.Local_ID = params.equipo1_id THEN p.Goles_Visita
            WHEN p.Visita_ID = params.equipo1_id THEN p.Goles_Local 
        END
    ) AS GF_Equipo2,
    SUM(
        CASE 
            WHEN p.Local_ID = params.equipo1_id THEN p.Goles_Local - p.Goles_Visita
            WHEN p.Visita_ID = params.equipo1_id THEN p.Goles_Visita - p.Goles_Local 
        END
    ) AS Diferencia_Goles
  
FROM partidos p
CROSS JOIN params
WHERE (p.Local_ID = params.equipo1_id AND p.Visita_ID = params.equipo2_id)
   OR (p.Local_ID = params.equipo2_id AND p.Visita_ID = params.equipo1_id);



   -------------TABLA HISTORICA

   WITH partidos_nombres AS (
    SELECT
        p.ID_MATCH,
        el.Nombre AS Local,
        ev.Nombre AS Visita,
        p.Goles_Local,
        p.Goles_Visita
    FROM Partidos p
    JOIN Equipos el ON p.Local_ID = el.ID_TEAM
    JOIN Equipos ev ON p.Visita_ID = ev.ID_TEAM
),
stats_local AS (
    SELECT 
        Local AS equipo,
        COUNT(*) FILTER (WHERE Goles_Local > Goles_Visita) AS ganados_local,
        COUNT(*) FILTER (WHERE Goles_Local < Goles_Visita) AS derrotas_local,
        COUNT(*) FILTER (WHERE Goles_Local = Goles_Visita) AS empates_local,
        SUM(Goles_Local) AS gf_local,
        SUM(Goles_Visita) AS gc_local
    FROM partidos_nombres
    GROUP BY Local
),
stats_visita AS (
    SELECT 
        Visita AS equipo,
        COUNT(*) FILTER (WHERE Goles_Visita > Goles_Local) AS ganados_visita,
        COUNT(*) FILTER (WHERE Goles_Visita < Goles_Local) AS derrotas_visita,
        COUNT(*) FILTER (WHERE Goles_Visita = Goles_Local) AS empates_visita,
        SUM(Goles_Visita) AS gf_visita,
        SUM(Goles_Local) AS gc_visita
    FROM partidos_nombres
    GROUP BY Visita
)
SELECT 
    e.Nombre AS equipo,
    COALESCE(l.ganados_local,0) AS ganados_local,
    COALESCE(v.ganados_visita,0) AS ganados_visita,
    COALESCE(l.ganados_local,0) + COALESCE(v.ganados_visita,0) AS ganados,
    COALESCE(l.empates_local,0) + COALESCE(v.empates_visita,0) AS empates,
    COALESCE(l.derrotas_local,0) AS derrotas_local,
    COALESCE(v.derrotas_visita,0) AS derrotas_visita,
    COALESCE(l.derrotas_local,0) + COALESCE(v.derrotas_visita,0) AS derrotas,
    COALESCE(l.gf_local,0) + COALESCE(v.gf_visita,0) AS gf,
    COALESCE(l.gc_local,0) + COALESCE(v.gc_visita,0) AS gc,
    (COALESCE(l.gf_local,0) + COALESCE(v.gf_visita,0)) - (COALESCE(l.gc_local,0) + COALESCE(v.gc_visita,0)) AS diferencia_goles,
    (COALESCE(l.ganados_local,0) + COALESCE(v.ganados_visita,0)) * 3 +
    (COALESCE(l.empates_local,0) + COALESCE(v.empates_visita,0)) AS puntos,
    ROUND(
        ((COALESCE(l.ganados_local,0) + COALESCE(v.ganados_visita,0)) * 3 +
        (COALESCE(l.empates_local,0) + COALESCE(v.empates_visita,0)))::numeric / 
        (GREATEST((COALESCE(l.ganados_local,0) + COALESCE(v.ganados_visita,0) +
          COALESCE(l.derrotas_local,0) + COALESCE(v.derrotas_visita,0) +
          COALESCE(l.empates_local,0) + COALESCE(v.empates_visita,0))*3,1)) * 100, 2
    ) AS porcentaje_rendimiento,
    (COALESCE(l.ganados_local,0) + COALESCE(v.ganados_visita,0) +
     COALESCE(l.derrotas_local,0) + COALESCE(v.derrotas_visita,0) +
     COALESCE(l.empates_local,0) + COALESCE(v.empates_visita,0)) AS partidos_jugados
FROM Equipos e
LEFT JOIN stats_local l ON e.Nombre = l.equipo
LEFT JOIN stats_visita v ON e.Nombre = v.equipo
ORDER BY e.Nombre;


RESUMEN FECHAS APLIK VS BOXEF------

WITH partidos_con_seccion AS (
    SELECT 
        p.id_match,
        p.fecha::date AS fecha,
        p.torneo,
        el.nombre AS equipo_local,
        ev.nombre AS equipo_visita,
        p.goles_local,
        p.goles_visita,
        CASE WHEN el.id_team % 2 = 0 THEN 'Aplik' ELSE 'Boxef' END AS seccion_local,
        CASE WHEN ev.id_team % 2 = 0 THEN 'Aplik' ELSE 'Boxef' END AS seccion_visita
    FROM partidos p
    JOIN equipos el ON p.local_id = el.id_team
    JOIN equipos ev ON p.visita_id = ev.id_team
),
fechas_aplik_boxef AS (
    SELECT 
        fecha
    FROM partidos_con_seccion
    GROUP BY fecha
    HAVING BOOL_AND(seccion_local <> seccion_visita)
)
SELECT 
    p.fecha,
    p.torneo,
    p.equipo_local,
    p.seccion_local,
    p.goles_local,
    p.goles_visita,
    p.equipo_visita,
    p.seccion_visita
FROM partidos_con_seccion p
JOIN fechas_aplik_boxef f ON p.fecha = f.fecha
ORDER BY p.fecha, p.id_match;

----------------------------------------HEAD 2 HEAD HISTORICO APLIK VS BOXEF

WITH partidos_con_seccion AS (
    SELECT 
        p.id_match,
        p.fecha::date AS fecha,
        CASE WHEN el.id_team % 2 = 0 THEN 'Aplik' ELSE 'Boxef' END AS seccion_local,
        CASE WHEN ev.id_team % 2 = 0 THEN 'Aplik' ELSE 'Boxef' END AS seccion_visita,
        p.goles_local,
        p.goles_visita
    FROM partidos p
    JOIN equipos el ON p.local_id = el.id_team
    JOIN equipos ev ON p.visita_id = ev.id_team
),
fechas_aplik_boxef AS (
    SELECT fecha
    FROM partidos_con_seccion
    GROUP BY fecha
    HAVING BOOL_AND(seccion_local <> seccion_visita)
),
resumen_fecha AS (
    SELECT 
        fecha,
        SUM(CASE WHEN seccion_local = 'Aplik' THEN goles_local
                 WHEN seccion_visita = 'Aplik' THEN goles_visita END) AS goles_aplik,
        SUM(CASE WHEN seccion_local = 'Boxef' THEN goles_local
                 WHEN seccion_visita = 'Boxef' THEN goles_visita END) AS goles_boxef
    FROM partidos_con_seccion
    WHERE fecha IN (SELECT fecha FROM fechas_aplik_boxef)
    GROUP BY fecha
)
SELECT
    COUNT(*) AS partidos_jugados,               -- cada fecha cuenta como 1
    SUM(CASE WHEN goles_aplik > goles_boxef THEN 1 ELSE 0 END) AS ganados_aplik,
    SUM(CASE WHEN goles_aplik = goles_boxef THEN 1 ELSE 0 END) AS empates,
    SUM(CASE WHEN goles_aplik < goles_boxef THEN 1 ELSE 0 END) AS ganados_boxef,
    SUM(goles_aplik) AS gf_aplik,
    SUM(goles_boxef) AS gf_boxef,
    SUM(goles_aplik - goles_boxef) AS diferencia_goles
FROM resumen_fecha;



